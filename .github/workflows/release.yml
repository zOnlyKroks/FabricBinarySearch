name: Release Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      draft:
        description: 'Create as draft release'
        required: false
        type: boolean
        default: true

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Delete existing release if exists
        continue-on-error: true
        run: |
          gh release delete ${{ github.event.inputs.version }} --yes --cleanup-tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.version }}
          release_name: Release ${{ github.event.inputs.version }}
          draft: ${{ github.event.inputs.draft }}
          prerelease: false

  build:
    name: Build ${{ matrix.platform }} ${{ matrix.arch }}
    needs: create-release
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64
          - os: ubuntu-latest
            platform: linux
            arch: x64
            cmake_arch: ''
            vcpkg_triplet: x64-linux
            artifact_name: FabricBinarySearch-linux-x64
            binary_name: FabricBinarySearch

          # Linux ARM64 (headless - no GUI due to cross-compilation complexity)
          - os: ubuntu-latest
            platform: linux
            arch: arm64
            cmake_arch: '-DCMAKE_SYSTEM_PROCESSOR=aarch64 -DBUILD_GUI=OFF'
            vcpkg_triplet: arm64-linux
            artifact_name: FabricBinarySearch-linux-arm64
            binary_name: FabricBinarySearch

          # macOS x64 (Intel)
          - os: macos-13
            platform: macos
            arch: x64
            cmake_arch: '-DCMAKE_OSX_ARCHITECTURES=x86_64'
            vcpkg_triplet: x64-osx
            artifact_name: FabricBinarySearch-macos-x64
            binary_name: FabricBinarySearch

          # macOS ARM64 (Apple Silicon) - native build on ARM64 runner
          - os: macos-latest
            platform: macos
            arch: arm64
            cmake_arch: ''
            vcpkg_triplet: arm64-osx
            artifact_name: FabricBinarySearch-macos-arm64
            binary_name: FabricBinarySearch

          # Windows x64
          - os: windows-latest
            platform: windows
            arch: x64
            cmake_arch: '-A x64'
            vcpkg_triplet: x64-windows-static
            artifact_name: FabricBinarySearch-windows-x64
            binary_name: FabricBinarySearch.exe

          # Windows ARM64
          - os: windows-latest
            platform: windows
            arch: arm64
            cmake_arch: '-A ARM64'
            vcpkg_triplet: arm64-windows-static
            artifact_name: FabricBinarySearch-windows-arm64
            binary_name: FabricBinarySearch.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libx11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libxxf86vm-dev

      - name: Install Linux ARM64 cross-compilation tools
        if: matrix.platform == 'linux' && matrix.arch == 'arm64'
        run: |
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            wayland-scanner++ \
            libgl1-mesa-dev:arm64 \
            libglu1-mesa-dev:arm64 \
            libx11-dev:arm64 \
            libxrandr-dev:arm64 \
            libxinerama-dev:arm64 \
            libxcursor-dev:arm64 \
            libxi-dev:arm64 \
            libxxf86vm-dev:arm64 \
            libwayland-dev:arm64 \
            libxkbcommon-dev:arm64
          echo "CC=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CXX=aarch64-linux-gnu-g++" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig" >> $GITHUB_ENV

      - name: Install vcpkg dependencies
        run: |
          ${{ github.workspace }}/vcpkg/vcpkg install zlib --triplet=${{ matrix.vcpkg_triplet }}

      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=${{ matrix.vcpkg_triplet }} ${{ matrix.cmake_arch }}

      - name: Build
        run: cmake --build build --config Release

      - name: Package artifacts
        shell: bash
        run: |
          mkdir -p dist
          if [ "${{ matrix.platform }}" = "windows" ]; then
            cp build/Release/${{ matrix.binary_name }} dist/ || cp build/${{ matrix.binary_name }} dist/
          else
            cp build/${{ matrix.binary_name }} dist/
          fi
          cd dist
          if [ "${{ matrix.platform }}" = "windows" ]; then
            7z a ../${{ matrix.artifact_name }}.zip *
          else
            tar -czf ../${{ matrix.artifact_name }}.tar.gz *
          fi

      - name: Upload Linux/macOS Release Asset
        if: matrix.platform != 'windows'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./${{ matrix.artifact_name }}.tar.gz
          asset_name: ${{ matrix.artifact_name }}.tar.gz
          asset_content_type: application/gzip

      - name: Upload Windows Release Asset
        if: matrix.platform == 'windows'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./${{ matrix.artifact_name }}.zip
          asset_name: ${{ matrix.artifact_name }}.zip
          asset_content_type: application/zip

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/*
          retention-days: 7